<!DOCTYPE html><h2 id="background">Background</h2>
<p>Previously, I set up a 10GB storage, unlimited bandwidth cloud storage using <a href="https://www.backblaze.com/cloud-storage">Backblaze B2</a> and Cloudflare, which I use for daily file sharing and as an image hosting service for my blog. It works well with uPic. However, when using it as an image hosting service for my blog, I found that it doesn’t support image resizing/cropping. I often use Alibaba Cloud OSS for image processing at work, and I couldn’t stand the limitation, so I decided to create my own service.</p>
<blockquote>
<p>The free version of Workers only has a CPU limit of 10ms, and it frequently exceeds the resource usage limit, resulting in a high rate of image cracking. Now it has been adapted to Vercel Edge, which can be used with a CDN. See <a href="https://chi.miantiao.me/post/cloudflare-worker-image/">https://chi.miantiao.me/post/cloudflare-worker-image/</a></p>
</blockquote>
<h2 id="process">Process</h2>
<p>After some research, I considered two options:</p>
<ol>
<li>
<p>Use Cloudflare to proxy <a href="https://vercel.com/docs/image-optimization">Vercel Image</a>. With this option, the traffic goes through Cloudflare -> Vercel -> Cloudflare -> Backblaze, which is not ideal in terms of stability and speed. Additionally, it only allows 1000 image processing requests per month, which is quite limited.</p>
</li>
<li>
<p>Use the public service <a href="https://images.weserv.nl/">wsrv.nl</a>. With this option, the traffic goes through Cloudflare -> wsrv.nl -> Cloudflare -> Backblaze, and the domain is not under my control. If I want to control the domain, I would have to go through Cloudflare Worker again, which adds complexity.</p>
</li>
</ol>
<p>Since neither option was ideal, I kept looking for alternatives. Last week, when I was working on an Email Worker, I discovered that Cloudflare Worker supports <a href="https://developers.cloudflare.com/workers/runtime-apis/webassembly/">WebAssembly (Wasm)</a>, which sparked the idea of using Worker + WebAssembly to process images.</p>
<p>Initially, I wanted to use <a href="https://sharp.pixelplumbing.com/">sharp</a>, which I had used when working with Node.js. However, the author mentioned that Cloudflare Worker does not support multithreading, so sharp cannot run on Cloudflare Worker in the short term.</p>
<p>I searched online and found that a popular Rust library for image processing is <a href="https://silvia-odwyer.github.io/photon/">Photon</a>, and there is also a <a href="https://github.com/techwithdeo/cloudflare-workers/tree/main/photon-library">demo</a> in the community. I tried it out and confirmed that it can run on Cloudflare Worker. However, the demo has two drawbacks:</p>
<ol>
<li>Photon needs to be manually updated and cannot keep up with the official updates as quickly.</li>
<li>It can only output images in PNG format, and the file size of JPG images actually becomes larger after resizing.</li>
</ol>
<h2 id="result">Result</h2>
<p>Based on the keywords “Photon + Worker”, I did further research and came up with a new solution inspired by <a href="https://denoflare.dev/examples/transform-images-wasm">DenoFlare</a> and <a href="https://github.com/jamsinclair/jSquash">jSquash</a>. In the end, I used the official Photon (with patch-package as a dependency), Squash WebAssembly, and Cloudflare Worker to create an image processing service for resizing images. <em>I originally wanted to support output in AVIF and JPEG XL formats, but due to the 1MB size limit of the free version of Workers, I had to give up this feature</em>.</p>
<p>Supported features:</p>
<ol>
<li>Supports processing of PNG, JPG, BMP, ICO, and TIFF format images.</li>
<li>Can output images in JPG, PNG, and WEBP formats, with WEBP being the default.</li>
<li>Supports pipelining, allowing multiple operations to be executed.</li>
<li>Supports Cloudflare caching.</li>
<li>Supports whitelisting of image URLs to prevent abuse.</li>
<li>Degrades gracefully in case of exceptions, returning the original image (exceptions are not cached).</li>
</ol>
<h2 id="demo">Demo</h2>
<h3 id="format-conversion">Format Conversion</h3>
<h4 id="webp">webp</h4>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;format=webp" alt="webp"></p>
<h4 id="jpg">jpg</h4>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;format=jpg" alt="jpg"></p>
<h4 id="png">png</h4>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;format=png" alt="png"></p>
<h3 id="resizing">Resizing</h3>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=resize!830,400,2" alt="resize"></p>
<h3 id="rotation">Rotation</h3>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=rotate!90" alt="rotate"></p>
<h3 id="cropping">Cropping</h3>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=crop!0,0,1000,1000" alt="rotate"></p>
<h3 id="filters">Filters</h3>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=filter%21obsidian" alt="filter"></p>
<h3 id="image-watermark">Image Watermark</h3>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=watermark!https%3A%2F%2Fstatic.miantiao.me%2Fshare%2F6qIq4w%2FFhSUzU.png,20,20" alt="watermark"></p>
<h3 id="text-watermark">Text Watermark</h3>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=draw_text!miantiao.me,20,20" alt="draw_text"></p>
<h3 id="pipeline-operations">Pipeline Operations</h3>
<h4 id="resize--rotate--text-watermark">Resize + Rotate + Text Watermark</h4>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=resize!830,400,2%7Crotate!180%7Cdraw_text!miantiao.me,10,10" alt="resize &#x26; rotate &#x26; draw_text"></p>
<h4 id="resize--image-watermark">Resize + Image Watermark</h4>
<p><img src="https://image.miantiao.me/?url=https%3A%2F%2Fstatic.miantiao.me%2Fshare%2FMTyerw%2Fbanner-2048.jpeg&#x26;action=resize!830,400,2%7Cwatermark!https%3A%2F%2Fstatic.miantiao.me%2Fshare%2F6qIq4w%2FFhSUzU.png,10,10" alt="resize &#x26; watermark"></p>
<p>In theory, it supports all the operations of Photon. If you are interested, you can check the image URLs and modify the parameters according to the <a href="https://docs.rs/photon-rs/latest/photon_rs/">Photon documentation</a> to try it out yourself. If you encounter any issues, feel free to leave a comment and provide feedback.</p>
<h2 id="sharing">Sharing</h2>
<p>I have open-sourced this solution on my GitHub. If you need it, you can follow the documentation to deploy it.</p>
<p><a href="https://github.com/ccbikai/cloudflare-worker-image"><img src="https://github.html.zone/ccbikai/cloudflare-worker-image" alt="ccbikai/cloudflare-worker-image - GitHub"></a></p>
<hr>
<p><a href="https://www.buymeacoffee.com/ccbikai"><img src="https://static.miantiao.me/share/0WmsVP/CcmGr8.png" alt="Buy Me A Coffee"></a></p>