<!DOCTYPE html><p>Earlier, we solved the issues of <a href="https://dev.to/ccbikai/jie-jue-vercel-analytics-bei-adblock-ping-bi-wen-ti-1o21-temp-slug-5601874">Vercel Analytics</a> and <a href="https://dev.to/ccbikai/jie-jue-umami-bei-adblock-ping-bi-wen-ti-3kc2-temp-slug-2355567">Umami</a> being blocked by AdBlock, and now we are also going to solve the problem for <a href="https://email.ml/">Email.ML</a> which uses <a href="https://www.cloudflare.com/zh-cn/web-analytics/">Cloudflare Web Analytics</a>.</p>
<p>Cloudflare Web Analytics is blocked by the <code>||cloudflareinsights.com^</code> rule. Its script address is <code>https://static.cloudflareinsights.com/beacon.min.js</code>, and the data reporting address is <code>https://cloudflareinsights.com/cdn-cgi/rum</code>.</p>
<p><img src="https://static.miantiao.me/share/2024/U4WHW7/GtPNhj.png" alt="||cloudflareinsights.com^"></p>
<p>So, just like Umami, we will proxy the script address and forward the data to the data reporting address.</p>
<h2 id="solution">Solution</h2>
<p>Create a Worker in Cloudflare Workers and paste the following JavaScript code. Configure the domain and test if the script address can be accessed properly. Mine is <a href="https://cwa.miantiao.me/mt-demo.js">https://cwa.miantiao.me/mt-demo.js</a>. The <code>mt-demo</code> can be replaced with any disguise address, the script above is already adapted.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> CWA_API</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'https://cloudflareinsights.com/cdn-cgi/rum'</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> CWA_SCRIPT</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'https://static.cloudflareinsights.com/beacon.min.js'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">env</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> { pathname, search } </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> URL</span><span style="color:#E1E4E8">(request.url)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (pathname.</span><span style="color:#B392F0">endsWith</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'.js'</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#F97583">      let</span><span style="color:#E1E4E8"> response </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> caches.default.</span><span style="color:#B392F0">match</span><span style="color:#E1E4E8">(request)</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">response) {</span></span>
<span class="line"><span style="color:#E1E4E8">          response </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">CWA_SCRIPT</span><span style="color:#E1E4E8">, request)</span></span>
<span class="line"><span style="color:#E1E4E8">          ctx.</span><span style="color:#B392F0">waitUntil</span><span style="color:#E1E4E8">(caches.default.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(request, response.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()))</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> response</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> req</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">(request)</span></span>
<span class="line"><span style="color:#E1E4E8">    req.headers.</span><span style="color:#B392F0">delete</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"cookie"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> response</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`${</span><span style="color:#79B8FF">CWA_API</span><span style="color:#9ECBFF">}${</span><span style="color:#E1E4E8">search</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">, req)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> headers</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Object.</span><span style="color:#B392F0">fromEntries</span><span style="color:#E1E4E8">(response.headers.</span><span style="color:#B392F0">entries</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">response.headers.</span><span style="color:#B392F0">has</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Access-Control-Allow-Origin'</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#E1E4E8">      headers[</span><span style="color:#9ECBFF">'Access-Control-Allow-Origin'</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.headers.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Origin'</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">||</span><span style="color:#9ECBFF"> '*'</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">response.headers.</span><span style="color:#B392F0">has</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Access-Control-Allow-Headers'</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#E1E4E8">      headers[</span><span style="color:#9ECBFF">'Access-Control-Allow-Headers'</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'content-type'</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">response.headers.</span><span style="color:#B392F0">has</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Access-Control-Allow-Credentials'</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#E1E4E8">      headers[</span><span style="color:#9ECBFF">'Access-Control-Allow-Credentials'</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'true'</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Response</span><span style="color:#E1E4E8">(response.body, {</span></span>
<span class="line"><span style="color:#E1E4E8">      status: response.status,</span></span>
<span class="line"><span style="color:#E1E4E8">      headers</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<p>Then inject the script into your website project, referring to my code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">script</span><span style="color:#B392F0"> async</span><span style="color:#B392F0"> src</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">'https://cwa.miantiao.me/mt-demo.js'</span><span style="color:#B392F0"> data-cf-beacon</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">'{"send":{"to": "https://cwa.miantiao.me/mt-demo"},"token": "5403f4dc926c4e61a757d630b1ec21ad"}'</span><span style="color:#E1E4E8">>&#x3C;/</span><span style="color:#85E89D">script</span><span style="color:#E1E4E8">></span></span>
<span class="line"></span></code></pre>
<p><code>src</code> is the script address, replace <code>mt-demo</code> with any disguise address. <code>data-cf-beacon</code> contains the send to data reporting address, replace <code>mt-demo</code> with any disguise address, the script is already adapted. Remember to change the <code>token</code> to your siteâ€™s token.</p>
<p>You can verify it on <a href="https://email.ml/">Email.ML</a> or <a href="https://html.zone/">HTML.ZONE</a>.</p>
<p><strong>Note that using this solution requires disabling automatic configuration, otherwise the data will not be counted.</strong></p>
<p><img src="https://static.miantiao.me/share/2024/AnFeat/jqthrz.png" alt="Disable automatic configuration"></p>