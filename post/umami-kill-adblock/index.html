<!DOCTYPE html><p>I recently redesigned my <a href="https://mt.ci/">personal homepage</a> and used Umami for website analytics. However, there is an ongoing issue: users who have AdBlock installed are causing the analytics to fail.</p>
<p>For more information on how AdBlock works, you can refer to <a href="11">Resolving Vercel Analytics Blocked by AdBlock Issue</a>. The rule that blocks Umami is <code>||umami.is^$3p</code>, which blocks the script and data reporting URLs. To overcome this, we can use <a href="https://workers.cloudflare.com/">Cloudflare Workers</a> to proxy Umami.</p>
<p><img src="https://static.miantiao.me/share/2024/CNrM78/ha30pV.png" alt="||umami.is^$3p"></p>
<h2 id="solution">Solution</h2>
<p>Create a Cloudflare Worker and paste the following JavaScript code. If you are using the official Umami service, you don’t need to modify the code (remember to change UMAMI_HOST to your service URL). If you are using a self-hosted service, you can define the script and data reporting URLs using the <code>TRACKER_SCRIPT_NAME</code> and <code>COLLECT_API_ENDPOINT</code> environment variables, without the need for proxying.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> UMAMI_HOST</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'https://eu.umami.is'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">env</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">pathname</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">search</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> URL</span><span style="color:#E1E4E8">(request.url)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (pathname.</span><span style="color:#B392F0">endsWith</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'.js'</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#F97583">      let</span><span style="color:#E1E4E8"> response </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> caches.default.</span><span style="color:#B392F0">match</span><span style="color:#E1E4E8">(request)</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">response) {</span></span>
<span class="line"><span style="color:#E1E4E8">          response </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`${</span><span style="color:#79B8FF">UMAMI_HOST</span><span style="color:#9ECBFF">}/script.js`</span><span style="color:#E1E4E8">, request)</span></span>
<span class="line"><span style="color:#E1E4E8">          ctx.</span><span style="color:#B392F0">waitUntil</span><span style="color:#E1E4E8">(caches.default.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(request, response.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()))</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> response</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> req</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Request</span><span style="color:#E1E4E8">(request)</span></span>
<span class="line"><span style="color:#E1E4E8">    req.headers.</span><span style="color:#B392F0">delete</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"cookie"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    req.headers.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'x-client-ip'</span><span style="color:#E1E4E8">, req.headers.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'cf-connecting-ip'</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`${</span><span style="color:#79B8FF">UMAMI_HOST</span><span style="color:#9ECBFF">}${</span><span style="color:#E1E4E8">pathname</span><span style="color:#9ECBFF">}${</span><span style="color:#E1E4E8">search</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">, req)</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<p>Once you have created the Worker, configure the domain and test if the script URL can be accessed correctly. In my case, it is <a href="https://ums.miantiao.me/mt-demo.js">https://ums.miantiao.me/mt-demo.js</a>. You can replace “mt-demo” with any disguised URL, as the script has already been adapted.</p>
<p>Next, inject the script into your website project. You can refer to the official documentation at <a href="https://umami.is/docs/tracker-configuration">https://umami.is/docs/tracker-configuration</a> or use the following code as a reference:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#E1E4E8">&#x3C;</span><span style="color:#85E89D">script</span><span style="color:#B392F0"> defer</span><span style="color:#B392F0"> src</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"https://ums.miantiao.me/mt-demo.js"</span><span style="color:#B392F0"> data-host-url</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"https://ums.miantiao.me"</span><span style="color:#B392F0"> data-website-id</span><span style="color:#E1E4E8">=</span><span style="color:#9ECBFF">"0a10de75-03be-4fec-a521-4c62b91650ac"</span><span style="color:#E1E4E8">>&#x3C;/</span><span style="color:#85E89D">script</span><span style="color:#E1E4E8">></span></span>
<span class="line"></span></code></pre>
<p>In the above code, <code>src</code> refers to the script URL, <code>data-host-url</code> refers to the data reporting URL, and <code>data-website-id</code> refers to the website ID. Make sure to provide the correct website ID to ensure data reporting.</p>
<p>You can verify the implementation on <a href="https://mt.ci/">Noodle Lab</a> or this website.</p>